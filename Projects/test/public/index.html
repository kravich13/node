<!DOCTYPE html>

<form>
	<input type="file" name="sendfile"><br>
	<button type="submit" name="submit">Submit</button>
</form>

<button id="stop" onclick="uploader.stop()">Stop</button>

<script>
	class Uploader {
		constructor(file, onProgress) {
			this.file = file
			this.onProgress = onProgress

			this.fileId = file.name + '-' + file.size + '-' + file.lastModified
		}

		async getUploadedBytes() {
			const response = await fetch('status', {
				headers: {
					'File-Id': this.fileId
				}
			})
			if (!response.ok) {
				throw new Error('Can\'t get the uploaded bytes!')
			}
			return Number(await response.text())
		}

		async upload() {
			this.startByte = await this.getUploadedBytes()
			console.log('Start Byte: ', this.startByte)

			const xhr = this.xhr = new XMLHttpRequest()
			// xhr.onprogress = this.onProgress
			xhr.upload.onprogress = e => {
				console.log('Upload in progress...')
				console.log(e)
			}
			xhr.onprogress = e => {
				console.log('Download in progress...')
				console.log(e)
			}

			xhr.open("POST", 'upload')

			xhr.setRequestHeader('File-Id', this.fileId)
			xhr.setRequestHeader('Start-Byte', this.startByte)
			xhr.setRequestHeader('File-Type', this.file.type)
			// console.log(this.file)
			xhr.send(this.file.slice(this.startByte))

			// Return a Promise to have the result of the interaction: 
			// 1 - finished successfully (req and res)
			// 2 - aborted successfully
			// 3 - an error occured
			return await new Promise((resolve, reject) => {
				xhr.onload = e => {
					console.log(e)
					resolve(
						'The interaction is successfully finished: the Request is sent and the Response is received'
					)
				}

				xhr.onabort = e => {
					console.log(e)
					resolve('Abort!')
				}

				xhr.onerror = e => {
					console.log(e)
					reject(new Error(xhr.statusText))
				}
			})
		}

		stop() {
			if (this.xhr) {
				this.xhr.abort()
			}
		}
	}

	function displayProgress() {
		console.log('progress')
	}

	async function submitForm(e) {
		e.preventDefault()

		let file = document.forms[0].sendfile.files[0]
		if (!file) return

		uploader = new Uploader(file, displayProgress)

		try {
			const result = await uploader.upload()
			console.log(result)
		} catch (err) {
			console.error(err)
		}
	}

	const $form = document.forms[0]
	$form.addEventListener('submit', e => submitForm(e))

	let uploader
</script>